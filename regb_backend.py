diff --git a/regb_backend.py b/regb_backend.pyindex a8c9e0c917bcb910b84635013265740663b58e7b..492165adcc406dd6520de5d3996cd437d5f446ad 100644--- a/regb_backend.py+++ b/regb_backend.py@@ -1,51 +1,66 @@ """ Reg-B Backend - Issue of Country Liquor in Bottles Database operations and business logic for finished goods inventory and production fees """ +import os import sqlite3 from datetime import date, datetime, timedelta from typing import List, Dict, Optional, Tuple from decimal import Decimal import logging  from regb_schema import (     ProductionFeesAccount,     BottleStockInventory,     RegBDailySummary,     CREATE_REGB_PRODUCTION_FEES_TABLE,     CREATE_REGB_BOTTLE_STOCK_TABLE,     CREATE_REGB_DAILY_SUMMARY_TABLE,     CREATE_REGB_INDEXES,     FEE_PER_BOTTLE )  # Configure logging logging.basicConfig(level=logging.INFO) logger = logging.getLogger(__name__) +import desktop_storage+++def _serialize_model(model) -> Dict:+    data = model.model_dump()+    for key, value in data.items():+        if isinstance(value, Decimal):+            data[key] = float(value)+        elif isinstance(value, date):+            data[key] = value.isoformat()+        elif isinstance(value, datetime):+            data[key] = value.isoformat()+    return data+ # Database path DB_PATH = "excise_registers.db"  # ============================================================================ # DATABASE INITIALIZATION # ============================================================================  def init_regb_database():     """Initialize Reg-B database tables"""     try:         conn = sqlite3.connect(DB_PATH)         cursor = conn.cursor()                  # Create tables         cursor.executescript(CREATE_REGB_PRODUCTION_FEES_TABLE)         cursor.executescript(CREATE_REGB_BOTTLE_STOCK_TABLE)         cursor.executescript(CREATE_REGB_DAILY_SUMMARY_TABLE)         cursor.executescript(CREATE_REGB_INDEXES)                  conn.commit()         conn.close()         logger.info("✅ Reg-B database initialized successfully")         return True     except Exception as e:         logger.error(f"❌ Error initializing Reg-B database: {e}")@@ -117,50 +132,56 @@ def save_production_fees(fees_data: ProductionFeesAccount) -> bool:                     status, created_at, updated_at                 ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)             """, (                 str(fees_data.date),                 float(fees_data.opening_balance),                 float(fees_data.deposit_amount),                 fees_data.echallan_no,                 str(fees_data.echallan_date) if fees_data.echallan_date else None,                 float(fees_data.total_credited),                 fees_data.iml_bottles_qty,                 fees_data.total_bottles_produced,                 float(fees_data.fee_per_bottle),                 float(fees_data.total_fees_debited),                 float(fees_data.closing_balance),                 fees_data.remarks,                 fees_data.excise_officer_name,                 fees_data.excise_officer_signature,                 fees_data.status,                 now,                 now             ))                  conn.commit()         conn.close()         logger.info(f"✅ Production fees saved for {fees_data.date}")+        desktop_storage.save_regb_fees_to_excel(_serialize_model(fees_data))+        try:+            from handbook_generator_v2 import EnhancedHandbookGenerator+            EnhancedHandbookGenerator(fees_data.date).generate_handbook()+        except Exception as e:+            logger.warning(f"Handbook generation warning: {e}")         return True     except Exception as e:         logger.error(f"❌ Error saving production fees: {e}")         return False   def get_production_fees(target_date: date) -> Optional[ProductionFeesAccount]:     """Get production fees account for a specific date"""     try:         conn = sqlite3.connect(DB_PATH)         conn.row_factory = sqlite3.Row         cursor = conn.cursor()                  cursor.execute("SELECT * FROM regb_production_fees WHERE date = ?", (str(target_date),))         row = cursor.fetchone()         conn.close()                  if row:             return ProductionFeesAccount(                 regb_fees_id=row['regb_fees_id'],                 date=datetime.strptime(row['date'], '%Y-%m-%d').date(),                 opening_balance=Decimal(str(row['opening_balance'])),                 deposit_amount=Decimal(str(row['deposit_amount'])),                 echallan_no=row['echallan_no'],                 echallan_date=datetime.strptime(row['echallan_date'], '%Y-%m-%d').date() if row['echallan_date'] else None,@@ -284,50 +305,56 @@ def save_bottle_stock(stock_data: BottleStockInventory) -> bool:                 stock_data.quantity_received_bottles,                 stock_data.total_accounted_bottles,                 stock_data.wastage_breakage_bottles,                 stock_data.issue_on_duty_bottles,                 stock_data.closing_balance_bottles,                 float(stock_data.opening_balance_bl),                 float(stock_data.received_bl),                 float(stock_data.total_bl),                 float(stock_data.wastage_bl),                 float(stock_data.issue_bl),                 float(stock_data.closing_bl),                 float(stock_data.opening_balance_al),                 float(stock_data.received_al),                 float(stock_data.total_al),                 float(stock_data.wastage_al),                 float(stock_data.issue_al),                 float(stock_data.closing_al),                 stock_data.status,                 now,                 now             ))                  conn.commit()         conn.close()         logger.info(f"✅ Bottle stock saved for {stock_data.date} - {stock_data.product_name} ({stock_data.bottle_size_ml}ml)")+        desktop_storage.save_regb_bottle_stock_to_excel(_serialize_model(stock_data))+        try:+            from handbook_generator_v2 import EnhancedHandbookGenerator+            EnhancedHandbookGenerator(stock_data.date).generate_handbook()+        except Exception as e:+            logger.warning(f"Handbook generation warning: {e}")                  # --- AUTOMATION HOOK: Update Excise Duty Register ---         try:             if stock_data.issue_on_duty_bottles > 0:                 import excise_duty_backend                 # Trigger duty register to pull latest issues                 duty_data = excise_duty_backend.get_regb_issued_bottles(stock_data.date)                 # Note: Duty register usually handles its own ledger entry                 # This ensures the duty backend is 'aware' or we could auto-save a ledger entry here         except Exception as e:             logger.warning(f"Duty Automation Hook Warning: {e}")                  return True     except Exception as e:         logger.error(f"❌ Error saving bottle stock: {e}")         return False   def get_bottle_stock_for_date(target_date: date) -> List[BottleStockInventory]:     """Get all bottle stock entries for a specific date"""     try:         conn = sqlite3.connect(DB_PATH)         conn.row_factory = sqlite3.Row         cursor = conn.cursor()         