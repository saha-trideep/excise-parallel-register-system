import argparseimport sqlite3from pathlib import Pathfrom typing import Dict, Optionalimport pandas as pdfrom openpyxl import load_workbookTEMPLATE_PATH = Path(__file__).with_name("Register Format.xlsx")DEFAULT_OUTPUT = Path.home() / "Desktop" / "Excise_Register_Data" / "Register Format.xlsx"DATA_PATHS = {    "reg76": Path("reg76_data.csv"),    "reg74": Path("reg74_data.csv"),    "rega": Path("rega_data.csv"),    "reg78": Path("reg78_data.csv"),    "db": Path("excise_registers.db"),}def _resolve_data_paths(data_root: Optional[Path]) -> Dict[str, Path]:    if data_root is None:        return DATA_PATHS    return {key: data_root / value for key, value in DATA_PATHS.items()}def _load_csv(path: Path) -> pd.DataFrame:    if path.exists():        return pd.read_csv(path)    return pd.DataFrame()def _load_table(db_path: Path, table: str) -> pd.DataFrame:    if not db_path.exists():        return pd.DataFrame()    with sqlite3.connect(db_path) as conn:        try:            return pd.read_sql_query(f"SELECT * FROM {table}", conn)        except Exception:            return pd.DataFrame()    return pd.DataFrame()def _parse_date_series(series: pd.Series) -> pd.Series:    return pd.to_datetime(series, errors="coerce").dt.datedef _normalize_label(value: Optional[str]) -> str:    if value is None:        return ""    return str(value).strip().lower()def _find_row_by_label(ws, label: str) -> Optional[int]:    for row in ws.iter_rows():        for cell in row:            if cell.value == label:                return cell.row    return Nonedef _find_header_row(ws, label: str) -> Optional[int]:    for row in ws.iter_rows():        for cell in row:            if isinstance(cell.value, str) and cell.value.strip() == label:                return cell.row    return Nonedef _header_index(ws, row_idx: int) -> Dict[str, int]:    header = {}    for cell in ws[row_idx]:        if isinstance(cell.value, str):            header[cell.value.strip()] = cell.column    return headerdef _next_empty_row(ws, start_row: int, col: int) -> int:    row = start_row    while ws.cell(row=row, column=col).value:        row += 1    return rowdef _write_reg76(ws, df: pd.DataFrame) -> None:    if df.empty:        return    latest = df.iloc[-1]    field_map = {        "Import Permit No./Transport Pass No.": "permit_no",        "Name of Exporting/Transporting Distillery": "distillery",        "Vechile No./Tanker No.": "vehicle_no",        "Date of Arrival": "date_arrival",        "Date of Receipt & date of Examination": "date_receipt",        "Export/import Order No. & Date": ("export_order_no", "export_order_date"),        "Export/Import Pass No. & Date": ("export_pass_no", "export_pass_date"),        "Nature of Spirit": "spirit_nature",        "No. of drum or Tanker": "num_tankers",        "Capacity of each Drum/Tanker": "tanker_capacity",        "Weight of Empty Drum/Tanker": "empty_tanker_weight_kg",        "weight of spirit in Advice (in Kg)": "adv_weight_kg",        "Average density of Spirit (gm/cc)": "adv_avg_density",        "Average Temperature of Spirit": "adv_temp",    }    for label, field in field_map.items():        row = _find_row_by_label(ws, label)        if not row:            continue        if isinstance(field, tuple):            value = ""            parts = [str(latest.get(part, "") or "") for part in field]            value = " ".join([p for p in parts if p])        else:            value = latest.get(field, "")        ws.cell(row=row, column=2, value=value)    # Advised/received quantities block    mass_row = _find_row_by_label(ws, "Mas (in kg.)")    if mass_row:        ws.cell(row=mass_row, column=2, value=latest.get("adv_weight_kg", ""))        ws.cell(row=mass_row, column=7, value=latest.get("rec_mass_kg", ""))def _write_reg74(ws, df: pd.DataFrame) -> None:    if df.empty:        return    header_row = _find_header_row(ws, "Date & Hours")    if not header_row:        return    header = _header_index(ws, header_row)    start_row = header_row + 2    for _, row in df.iterrows():        target_row = _next_empty_row(ws, start_row, header.get("Date & Hours", 1))        ws.cell(row=target_row, column=header.get("Date & Hours", 1), value=row.get("operation_date"))        ws.cell(row=target_row, column=header.get("Dip in CM", 2), value=row.get("opening_dip_cm"))        ws.cell(row=target_row, column=header.get("Temperature in Deg.C", 3), value=row.get("opening_temp"))        ws.cell(row=target_row, column=header.get("Indication in \nAlcoholmeter", 4), value=row.get("opening_indication"))        ws.cell(row=target_row, column=header.get("Strength in % v/V", 5), value=row.get("source_opening_strength"))        ws.cell(row=target_row, column=header.get("Volume in Bulk Litre ", 6), value=row.get("source_opening_bl"))        ws.cell(row=target_row, column=header.get("Volume in Alcoholic Litre ", 7), value=row.get("source_opening_al"))        ws.cell(row=target_row, column=header.get("From Which Receiver ", 8), value=row.get("source_vat"))        ws.cell(row=target_row, column=header.get("Qty Received through Mass flow meter -I", 9), value=row.get("receipt_bl"))        ws.cell(row=target_row, column=header.get("Average Strength recorded by mass Flow Meter-I", 10), value=row.get("receipt_strength"))        ws.cell(row=target_row, column=header.get("Quantity received in A.L", 11), value=row.get("receipt_al"))        ws.cell(row=target_row, column=header.get("Destination or VAT No ", 25), value=row.get("destination_vat"))        ws.cell(row=target_row, column=header.get("Qty Transferred in BL", 30), value=row.get("issue_bl"))        ws.cell(row=target_row, column=header.get("Strength recorded by MFM-II in %v/v", 32), value=row.get("issue_strength"))        ws.cell(row=target_row, column=header.get("Quantity transferred in AL", 33), value=row.get("issue_al"))        ws.cell(row=target_row, column=header.get("Final dip in CM. recorded through RLT", 35), value=row.get("dip_reading_cm"))        ws.cell(row=target_row, column=header.get("Final Volumn of spirit in bulk litre recorded through RLT", 36), value=row.get("closing_bl"))        ws.cell(row=target_row, column=header.get("Strength in % v/v  ", 37), value=row.get("closing_strength"))        ws.cell(row=target_row, column=header.get("Qty in Alcoholic Litre", 38), value=row.get("closing_al"))        ws.cell(row=target_row, column=header.get("Nature of operations to be noted in this column ", 39), value=row.get("operation_type"))        ws.cell(row=target_row, column=header.get("Remarks ", 40), value=row.get("operation_remarks"))def _write_rega(ws, df: pd.DataFrame) -> None:    if df.empty:        return    header_row = _find_header_row(ws, "BASE BATCH No.")    if not header_row:        return    header = _header_index(ws, header_row)    start_row = header_row + 2    for _, row in df.iterrows():        target_row = _next_empty_row(ws, start_row, header.get("BASE BATCH No.", 1))        ws.cell(row=target_row, column=header.get("BASE BATCH No.", 1), value=row.get("batch_no"))        ws.cell(row=target_row, column=header.get("BATCH START DATE", 2), value=row.get("production_date"))        ws.cell(row=target_row, column=header.get("BRAND NAME", 3), value=row.get("brand_name"))        ws.cell(row=target_row, column=header.get("ALLOTED VAT No.", 4), value=row.get("source_brt_vat"))        ws.cell(row=target_row, column=header.get("FROM VAT No.", 5), value=row.get("source_brt_vat"))        ws.cell(row=target_row, column=header.get("STR IN % v/v", 6), value=row.get("brt_opening_strength"))        ws.cell(row=target_row, column=header.get("VOLUME IN BL", 7), value=row.get("brt_opening_bl"))        ws.cell(row=target_row, column=header.get("VOLUME IN AL", 8), value=row.get("brt_opening_al"))        ws.cell(row=target_row, column=header.get("AVG DENSITY IN gm/cc", 17), value=row.get("mfm2_density"))        ws.cell(row=target_row, column=header.get("AVG TEMP IN deg C", 18), value=row.get("mfm2_temperature"))        ws.cell(row=target_row, column=header.get("AVG STR IN % v/v", 19), value=row.get("mfm2_strength"))        ws.cell(row=target_row, column=header.get("TOTAL VOLUME TRANSFER IN BL", 20), value=row.get("mfm2_total_passed"))        ws.cell(row=target_row, column=header.get("TOTAL VOLUME TRANSFER IN AL", 21), value=row.get("mfm2_reading_al"))        ws.cell(row=target_row, column=header.get(750, 22), value=row.get("bottles_750ml"))        ws.cell(row=target_row, column=header.get(600, 23), value=row.get("bottles_600ml"))        ws.cell(row=target_row, column=header.get(500, 24), value=row.get("bottles_500ml"))        ws.cell(row=target_row, column=header.get(375, 25), value=row.get("bottles_375ml"))        ws.cell(row=target_row, column=header.get(300, 26), value=row.get("bottles_300ml"))        ws.cell(row=target_row, column=header.get(180, 27), value=row.get("bottles_180ml"))        ws.cell(row=target_row, column=header.get("SPIRIT BOTTLED IN BL", 28), value=row.get("bottles_total_bl"))        ws.cell(row=target_row, column=header.get("AVERAGE STRENGTH", 29), value=row.get("mfm2_strength"))        ws.cell(row=target_row, column=header.get("SPIRIT BOTTLED IN AL", 30), value=row.get("bottles_total_al"))        ws.cell(row=target_row, column=header.get("PRODUCTION INCREASE  ", 31), value=row.get("production_increase_al"))        ws.cell(row=target_row, column=header.get("PRODUCTION WASTAGE  ", 32), value=row.get("wastage_al"))        ws.cell(row=target_row, column=header.get("ALLOWABLE WASTAGE", 33), value=row.get("allowable_limit"))        ws.cell(row=target_row, column=header.get("CHARGEABLE WASTAGE", 34), value=row.get("chargeable_wastage_al"))        ws.cell(row=target_row, column=header.get("REMARKS", 35), value=row.get("operation_remarks"))def _write_reg78(ws, df: pd.DataFrame) -> None:    if df.empty:        return    header_row = _find_header_row(ws, "Date Hour")    if not header_row:        return    header = _header_index(ws, header_row)    start_row = header_row + 3    for _, row in df.iterrows():        target_row = _next_empty_row(ws, start_row, header.get("Date Hour", 1))        ws.cell(row=target_row, column=header.get("Date Hour", 1), value=row.get("synopsis_date"))        ws.cell(row=target_row, column=header.get("Balance in hand", 2), value=row.get("opening_balance_al"))        ws.cell(row=target_row, column=header.get("Consignment of strong spirit received through Pass Number", 3), value=row.get("consignment_pass_numbers"))        ws.cell(row=target_row, column=header.get("Quantity of spirit received through Mass Flow Meter-I", 4), value=row.get("mfm1_total_al"))        ws.cell(row=target_row, column=header.get("Operational Increase", 5), value=row.get("operational_increase_al"))        ws.cell(row=target_row, column=header.get("Production Increase", 6), value=row.get("production_increase_al"))        ws.cell(row=target_row, column=header.get("Increase during stock Audit", 7), value=row.get("audit_increase_al"))        ws.cell(row=target_row, column=header.get("Total balance in hand (sum of col. 2 to 7", 8), value=row.get("total_credit_al"))        ws.cell(row=target_row, column=header.get("Issues on payment of duty", 9), value=row.get("issues_on_duty_al"))        ws.cell(row=target_row, column=header.get("Sample drawn", 10), value=row.get("sample_drawn_al"))        ws.cell(row=target_row, column=header.get("Operational wastage ", 11), value=row.get("operational_wastage_al"))        ws.cell(row=target_row, column=header.get("Production wastage", 12), value=row.get("production_wastage_al"))        ws.cell(row=target_row, column=header.get("Wastage during stock Audit", 13), value=row.get("audit_wastage_al"))        ws.cell(row=target_row, column=header.get("Total debit of spirit in difference (sum of col. 9 to 13", 14), value=row.get("total_debit_al"))        ws.cell(row=target_row, column=header.get("Spirit left in vats ", 15), value=row.get("closing_balance_al"))def _build_reg78_from_sources(    reg76_df: pd.DataFrame,    reg74_df: pd.DataFrame,    rega_df: pd.DataFrame,    existing_reg78: pd.DataFrame,) -> pd.DataFrame:    dates = set()    receipt_col = None    for candidate in ("receipt_date", "date_receipt"):        if candidate in reg76_df.columns:            receipt_col = candidate            break    if receipt_col:        dates.update(_parse_date_series(reg76_df[receipt_col]).dropna().tolist())    if "operation_date" in reg74_df.columns:        dates.update(_parse_date_series(reg74_df["operation_date"]).dropna().tolist())    if "production_date" in rega_df.columns:        dates.update(_parse_date_series(rega_df["production_date"]).dropna().tolist())    if not dates:        return existing_reg78    dates = sorted(dates)    existing_reg78 = existing_reg78.copy()    if not existing_reg78.empty and "synopsis_date" in existing_reg78.columns:        existing_reg78["synopsis_date"] = _parse_date_series(existing_reg78["synopsis_date"])    rows = []    previous_closing = 0.0    for date in dates:        if receipt_col:            reg76_day = reg76_df[_parse_date_series(reg76_df[receipt_col]) == date]        else:            reg76_day = reg76_df.iloc[0:0]        reg74_day = reg74_df[_parse_date_series(reg74_df.get("operation_date", pd.Series([]))) == date]        rega_day = rega_df[_parse_date_series(rega_df.get("production_date", pd.Series([]))) == date]        consignment_count = len(reg76_day)        consignment_pass_numbers = ", ".join(            reg76_day.get("permit_no", pd.Series([])).dropna().astype(str).tolist()        )        consignment_received_al = reg76_day.get("rec_al", pd.Series(dtype=float)).fillna(0).sum()        if not consignment_received_al:            consignment_received_al = reg76_day.get("receipt_al", pd.Series(dtype=float)).fillna(0).sum()        mfm1_total_al = reg76_day.get("mfm1_al", pd.Series(dtype=float)).fillna(0).sum()        if not mfm1_total_al:            mfm1_total_al = consignment_received_al        operational_increase_al = reg74_day.get("storage_wastage_al", pd.Series(dtype=float)).fillna(0).sum()        operational_wastage_al = reg74_day.get("wastage_al", pd.Series(dtype=float)).fillna(0).sum()        production_increase_al = rega_day.get("production_increase_al", pd.Series(dtype=float)).fillna(0).sum()        production_wastage_al = rega_day.get("wastage_al", pd.Series(dtype=float)).fillna(0).sum()        issues_on_duty_al = rega_day.get("bottles_total_al", pd.Series(dtype=float)).fillna(0).sum()        opening_balance_al = previous_closing        total_credit_al = (            opening_balance_al            + consignment_received_al            + operational_increase_al            + production_increase_al        )        total_debit_al = issues_on_duty_al + operational_wastage_al + production_wastage_al        closing_balance_al = total_credit_al - total_debit_al        rows.append(            {                "synopsis_date": date,                "opening_balance_al": opening_balance_al,                "consignment_count": consignment_count,                "consignment_pass_numbers": consignment_pass_numbers,                "consignment_received_al": consignment_received_al,                "mfm1_total_al": mfm1_total_al,                "operational_increase_al": operational_increase_al,                "production_increase_al": production_increase_al,                "total_credit_al": total_credit_al,                "issues_on_duty_al": issues_on_duty_al,                "operational_wastage_al": operational_wastage_al,                "production_wastage_al": production_wastage_al,                "total_debit_al": total_debit_al,                "closing_balance_al": closing_balance_al,            }        )        previous_closing = closing_balance_al    return pd.DataFrame(rows)def _write_regb(ws, stock: pd.DataFrame) -> None:    if stock.empty:        return    header_row = _find_header_row(ws, "Date")    if not header_row:        return    start_row = header_row + 2    row4 = header_row - 1    row5 = header_row    row6 = header_row + 1    columns = []    current_product = ""    for col in range(1, ws.max_column + 1):        section = _normalize_label(ws.cell(row=row4, column=col).value)        product_cell = _normalize_label(ws.cell(row=row5, column=col).value)        size = ws.cell(row=row6, column=col).value        if product_cell and product_cell != "al liters":            current_product = product_cell        product = current_product        columns.append((col, section, product, size))    stock = stock.copy()    if "date" not in stock.columns:        return    stock["date"] = _parse_date_series(stock["date"])    dates = sorted(stock["date"].dropna().unique())    for date in dates:        daily = stock[stock["date"] == date]        target_row = _next_empty_row(ws, start_row, 1)        ws.cell(row=target_row, column=1, value=date)        grouped = (            daily.groupby(["product_name", "strength", "bottle_size_ml"], dropna=False)            .first()            .reset_index()        )        totals = (            daily.groupby(["product_name", "strength"], dropna=False)            .sum(numeric_only=True)            .reset_index()        )        for col, section, product, size in columns:            if col == 1:                continue            if "al liters" in _normalize_label(ws.cell(row=row5, column=col).value) and size in (None, ""):                product_label = product                total_row = totals[                    totals["product_name"].str.lower().str.contains(product_label, na=False)                ]                if total_row.empty:                    continue                row_data = total_row.iloc[0]                field_map = {                    "opening balance in hand": "opening_balance_al",                    "quantity received of bottle": "received_al",                    "total bottle to be accounted": "total_al",                    "wastage/breakage of bottle": "wastage_al",                    "issue on payment of duty": "issue_al",                    "closing in hand of bottle": "closing_al",                }                for key, field in field_map.items():                    if key in section:                        ws.cell(row=target_row, column=col, value=row_data.get(field))                continue            if not size:                continue            size_value = int(size) if isinstance(size, (int, float)) else None            if size_value is None:                continue            matched = grouped[                (grouped["bottle_size_ml"] == size_value)                & grouped["product_name"].str.lower().str.contains(product, na=False)            ]            if matched.empty:                continue            row_data = matched.iloc[0]            field_map = {                "opening balance in hand": "opening_balance_bottles",                "quantity received of bottle": "quantity_received_bottles",                "total bottle to be accounted": "total_accounted_bottles",                "wastage/breakage of bottle": "wastage_breakage_bottles",                "issue on payment of duty": "issue_on_duty_bottles",                "closing in hand of bottle": "closing_balance_bottles",            }            for key, field in field_map.items():                if key in section:                    ws.cell(row=target_row, column=col, value=row_data.get(field))def _write_excise_duty(ws, ledger: pd.DataFrame, bottles: pd.DataFrame) -> None:    if ledger.empty:        return    header_row = _find_header_row(ws, "Date")    if not header_row:        return    header = _header_index(ws, header_row)    start_row = header_row + 2    ledger = ledger.copy()    ledger["date"] = _parse_date_series(ledger["date"])    bottles = bottles.copy()    if not bottles.empty:        bottles["date"] = _parse_date_series(bottles["date"])    for _, ledger_row in ledger.iterrows():        target_row = _next_empty_row(ws, start_row, header.get("Date", 1))        ws.cell(row=target_row, column=header.get("Date", 1), value=ledger_row.get("date"))        ws.cell(row=target_row, column=header.get("Opening Balance", 2), value=ledger_row.get("opening_balance"))        ws.cell(row=target_row, column=header.get("Deposit Amount", 3), value=ledger_row.get("deposit_amount"))        echallan = " ".join(            [                str(value)                for value in [ledger_row.get("echallan_no"), ledger_row.get("echallan_date")]                if value not in (None, "")            ]        )        ws.cell(row=target_row, column=header.get("E Challan No. & Date", 4), value=echallan)        ws.cell(row=target_row, column=header.get("Total Amount Credited", 5), value=ledger_row.get("amount_credited"))        ws.cell(row=target_row, column=header.get("Date of Issue", 6), value=ledger_row.get("date"))        ws.cell(            row=target_row,            column=header.get("Name of the Ware house/Depot's", 7),            value=ledger_row.get("name_of_issue"),        )        ws.cell(row=target_row, column=header.get("Transport Pass No.", 8), value=ledger_row.get("transport_permit_no"))        ws.cell(            row=target_row,            column=header.get("Amount of duty Debited for the Issue", 26),            value=ledger_row.get("duty_debited"),        )        ws.cell(row=target_row, column=header.get("Closing Balance", 27), value=ledger_row.get("closing_balance"))        ws.cell(row=target_row, column=header.get("Remarks", 28), value=ledger_row.get("remarks"))        if bottles.empty:            continue        row6 = header_row + 1        row7 = header_row + 2        group_labels = {}        for col in range(1, ws.max_column + 1):            group_label = _normalize_label(ws.cell(row=row6, column=col).value)            size_label = ws.cell(row=row7, column=col).value            if not group_label or not size_label:                continue            group_labels[col] = (group_label, size_label)        day_bottles = bottles[bottles["date"] == ledger_row.get("date")]        if day_bottles.empty:            continue        day_bottles = day_bottles.copy()        day_bottles["product_label"] = day_bottles["product_name"].astype(str).str.lower()        for col, (group_label, size_label) in group_labels.items():            size_value = int(size_label) if isinstance(size_label, (int, float)) else None            if size_value is None:                continue            matches = day_bottles[                (day_bottles["bottle_size_ml"] == size_value)                & day_bottles["product_label"].str.contains(group_label, na=False)            ]            if matches.empty:                continue            ws.cell(row=target_row, column=col, value=matches.iloc[0].get("qty_issued"))def export_register_format(    output_path: Path = DEFAULT_OUTPUT,    template_path: Path = TEMPLATE_PATH,    data_root: Optional[Path] = None,) -> Path:    if not template_path.exists():        raise FileNotFoundError(f"Template not found: {template_path}")    output_path.parent.mkdir(parents=True, exist_ok=True)    wb = load_workbook(template_path)    data_paths = _resolve_data_paths(data_root)    reg76_df = _load_csv(data_paths["reg76"])    reg74_df = _load_csv(data_paths["reg74"])    rega_df = _load_csv(data_paths["rega"])    reg78_existing = _load_csv(data_paths["reg78"])    regb_stock = _load_table(data_paths["db"], "regb_bottle_stock")    excise_ledger = _load_table(data_paths["db"], "excise_duty_ledger")    excise_bottles = _load_table(data_paths["db"], "excise_duty_bottles")    reg78_df = _build_reg78_from_sources(reg76_df, reg74_df, rega_df, reg78_existing)    if "REG 76" in wb.sheetnames:        _write_reg76(wb["REG 76"], reg76_df)    if "Reg-74" in wb.sheetnames:        _write_reg74(wb["Reg-74"], reg74_df)    if "REG-A" in wb.sheetnames:        _write_rega(wb["REG-A"], rega_df)    if "REG-78" in wb.sheetnames:        _write_reg78(wb["REG-78"], reg78_df)    if "REG-B" in wb.sheetnames:        _write_regb(wb["REG-B"], regb_stock)    if "Excise Duty" in wb.sheetnames:        _write_excise_duty(wb["Excise Duty"], excise_ledger, excise_bottles)    wb.save(output_path)    return output_pathif __name__ == "__main__":    parser = argparse.ArgumentParser(        description="Export register data into the official Register Format.xlsx template."    )    parser.add_argument(        "--output",        type=Path,        default=DEFAULT_OUTPUT,        help="Output path for the filled Register Format.xlsx workbook.",    )    parser.add_argument(        "--template",        type=Path,        default=TEMPLATE_PATH,        help="Path to the Register Format.xlsx template.",    )    parser.add_argument(        "--data-dir",        type=Path,        default=None,        help="Directory containing CSV/SQLite data files (defaults to repo root).",    )    args = parser.parse_args()    export_path = export_register_format(        output_path=args.output,        template_path=args.template,        data_root=args.data_dir,    )    print(f"âœ… Exported register workbook to: {export_path}")